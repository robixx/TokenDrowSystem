@{
    ViewData["Title"] = "ToKen Book";
    var totalTickets = ViewBag.TotalTickets as int? ?? 0;
    var bookedTokens = ViewBag.BookedTokens as List<dynamic> ?? new List<dynamic>();
    var Distance = ViewBag.Distance as int? ?? 0;
}


<link href="~/css/site.css" rel="stylesheet" />
<style>
    .token-btn {
        padding: 20px 33px;
        border: 1px solid #999;
        background: #ecf9f0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin: 14px;
    }

        .token-btn:hover {
            background: #e9ecef;
        }

    .selected-token {
        background: #28a745 !important;
        color: white;
        border-color: #1e7e34;
    }

    .selected-tokens {
        background: #28a745 !important;
        color: white;
        border-color: #1e7e34;
    }

    #selectedList .token-btns {
        padding: 5px 10px;
        font-size: 14px;
        cursor: pointer;
    }

    .token-btns {
        padding: 3px 7px;
        border: 1px solid #999;
        background: #ecf9f0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin: 3px;
    }

        .token-btns:hover {
            background: #e9ecef;
        }
</style>
<div class="bg-white p-2 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-600">
    <h4 class="text-center">Token Booking</h4>
    <hr />

    <div class="row">
        <div class="col-md-5 text-center">
            <div id="tokenFlow"></div>
        </div>

        <div class="col-md-6 mt-3">
            <h5 id="totalSelected">Total Selected: 0</h5>
            <h5>Selected Tokens:</h5>
            <div id="selectedList" class="d-flex flex-wrap"></div>
            <div class="mt-3">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input class="form-control" name="username" id="username" />
                </div>
                <div class="form-group mt-3">
                    <label class="form-label">Mobile number</label>
                    <input class="form-control" name="mobile" id="mobile" />
                </div>
                <div class="form-group mt-3 text-center mb-3">
                    <button type="button" id="confirmBooking" class="btn btn-success">Confirmation Booking</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const totalTokens = @totalTickets;
    const distance = @Distance;
    let clickedTokens = [];
    let blocks = [];   
    var bookedTokens = @Html.Raw(Json.Serialize(ViewBag.BookedTokens ?? new List<int>()));  
    
    function generateFlow() {
        const container = document.getElementById("tokenFlow");
        container.innerHTML = "";

        for (let start = 1; start <= totalTokens; start += distance) {
            const end = Math.min(start + distance - 1, totalTokens);
            blocks.push({ start, end });

            const startBtn = createButton(start);
            const endBtn = createButton(end);

            container.appendChild(startBtn);
            if (end !== start) container.appendChild(endBtn);
        }

        updateTokenUI(); 
    }

   
    function createButton(number) {
        const btn = document.createElement("button");
        btn.className = "token-btn";
        btn.innerText = number;
        btn.dataset.value = number;         
        
           const isBooked = bookedTokens.some(t => t.tokenNumber === number);
            if (isBooked) {
                btn.disabled = true;
                btn.style.background = "#eddbdb";
                btn.style.cursor = "not-allowed";
            } else {
                btn.addEventListener("click", () => handleTokenFlowClick(number));
            }

        return btn;
    }

    
    function handleTokenFlowClick(number) {
        const block = blocks.find(b => number >= b.start && number <= b.end);
        if (!block) return;

        const isSelected = clickedTokens.some(n => n >= block.start && n <= block.end);

        if (isSelected) {
           
            clickedTokens = clickedTokens.filter(n => n < block.start || n > block.end);
        } else {
           
            for (let i = block.start; i <= block.end; i++) {
                if (!clickedTokens.includes(i) && !bookedTokens.includes(i)) clickedTokens.push(i);
            }
        }

        updateTokenUI();
        updateSelectedTokens();
    }

    
    function updateTokenUI() {
        const buttons = document.querySelectorAll("#tokenFlow .token-btn");
        buttons.forEach(btn => {
            const val = parseInt(btn.dataset.value);
            if (clickedTokens.includes(val)) {
                btn.classList.add("selected-token");
            } else {
                btn.classList.remove("selected-token");
            }

           
            if (bookedTokens.includes(val)) {
                btn.disabled = true;
                btn.style.background = "#ccc";
                btn.style.cursor = "not-allowed";
                btn.classList.remove("selected-token"); 
            }
        });
    }

   
    function updateSelectedTokens() {
        const container = document.getElementById("selectedList");
        container.innerHTML = "";
        clickedTokens.sort((a, b) => a - b).forEach(num => {
            const token = document.createElement("span");
            token.className = "token-btns selected-tokens";
            token.innerText = num; 
            container.appendChild(token);
        });

        document.getElementById("totalSelected").innerText = "Total Selected: " + clickedTokens.length;
    }

    document.getElementById("confirmBooking")?.addEventListener("click", () => {
        const username = document.getElementById("username").value.trim();
        const mobile = document.getElementById("mobile").value.trim();
       
        if (!username || !mobile || clickedTokens.length === 0) {
            alert("Please enter name, mobile and select at least one token.");
            return;
        }
       
        const bookingData = {
            Name: username,
            Mobile: mobile,
            Tokens: clickedTokens.slice()
        };
        console.log(JSON.stringify(bookingData));
        debugger;
       // --- AJAX CALL ---
        $.ajax({
            url: '/TokenBook/SaveToken',
            type: 'POST',            
            data: JSON.stringify(bookingData),
            contentType: 'application/json',
            success: function (response) {
                alert(response.message);
               window.location.reload();
            },

            error: function (xhr, status, error) {
                console.error(xhr.responseText);
                alert("Error: " + error);
            }
        });
      
    });


    document.addEventListener("DOMContentLoaded", generateFlow);
</script>